FROM alpine/git as download_middleware
LABEL VERSION=0.6.3
ARG BRANCH=master
ARG REPO=https://github.com/halushko/kino-cat.git
RUN mkdir -p /home/git/code
RUN cd /home/git/code && \
    git init kino-cat && \
    cd kino-cat && \
    git remote add origin $REPO && \
    git config core.sparseCheckout true && \
    echo "middleware/" >> .git/info/sparse-checkout && \
    git pull origin $BRANCH

FROM alpine/git as download_bot
LABEL VERSION=0.6.3
ARG BRANCH=master
ARG REPO=https://github.com/halushko/kino-cat.git
RUN mkdir -p /home/git/code
RUN cd /home/git/code && \
    git init kino-cat && \
    cd kino-cat && \
    git remote add origin $REPO && \
    git config core.sparseCheckout true && \
    echo "bot/" >> .git/info/sparse-checkout && \
    git pull origin $BRANCH

FROM gradle:jdk8-alpine as build_middleware
RUN mkdir -p /home/gradle/code
RUN mkdir -p /home/gradle/app
COPY --chown=gradle:gradle --from=download_middleware /home/git/code /home/gradle/code
RUN cd /home/gradle/code/kino-cat/middleware && gradle jar && cp ./build/libs/*.jar /home/gradle/app/kot_utils.jar

FROM gradle:jdk8-alpine as build_bot
RUN mkdir -p /home/gradle/code
RUN mkdir -p /home/gradle/app
COPY --chown=gradle:gradle --from=build_middleware /home/gradle/app /home/gradle/app
COPY --chown=gradle:gradle --from=download_bot /home/git/code /home/gradle/code
RUN cd /home/gradle/code/kino-cat/bot && gradle fatJar && cp ./build/libs/*.jar /home/gradle/app/bot.jar

FROM openjdk:8-alpine as bot
COPY --from=build_bot /home/gradle/app /home/app
ENTRYPOINT ["java", "-jar", "/home/app/bot.jar"]